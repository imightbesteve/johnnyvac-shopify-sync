name: JohnnyVac to Shopify Sync

on:
  # Run daily at 7 AM UTC
  schedule:
    - cron: '0 7 * * *'

  # Allow manual triggering with options
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes made)'
        required: false
        type: boolean
        default: false
      create_collections:
        description: 'Create/update collections after sync'
        required: false
        type: boolean
        default: false
      auto_publish:
        description: 'Auto-publish new collections'
        required: false
        type: boolean
        default: false
      archive_missing:
        description: 'Archive products missing from CSV (set to DRAFT)'
        required: false
        type: boolean
        default: true

jobs:
  sync-products:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Validate configuration files
        run: |
          echo "Validating category_map_v4.json..."
          python - <<EOF
          import json
          import sys
          
          try:
              with open("category_map_v4.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
              
              assert "settings" in data, "Missing 'settings' key"
              assert "categories" in data, "Missing 'categories' key"
              assert "jv_category_mappings" in data, "Missing 'jv_category_mappings' key"
              
              print(f"âœ… Loaded {len(data['categories'])} categories")
              print(f"âœ… Loaded {len(data['jv_category_mappings'])} JV category mappings")
              print(f"âœ… Configuration valid")
              
          except Exception as e:
              print(f"âŒ Validation failed: {e}")
              sys.exit(1)
          EOF

      - name: Sync products to Shopify
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          ARCHIVE_MISSING: ${{ github.event.inputs.archive_missing || 'true' }}
        run: |
          echo "Starting JohnnyVac product sync..."
          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ”¸ DRY RUN MODE - No changes will be made"
          fi
          python -u sync_shopify_v2.py

      - name: Upload needs_review.csv artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: needs-review-report
          path: needs_review.csv
          if-no-files-found: ignore

      - name: Upload skipped_products.csv artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skipped-products-report
          path: skipped_products.csv
          if-no-files-found: ignore

      - name: Create/update automated collections (optional)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_collections == 'true'
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          AUTO_PUBLISH: ${{ github.event.inputs.auto_publish }}
        run: |
          echo "Creating / updating Shopify automated collections..."
          python create_collections.py

      - name: Job summary
        if: always()
        run: |
          {
            echo "## JohnnyVac â†’ Shopify Sync Summary"
            echo ""
            echo "### Run Configuration"
            echo "- ðŸ”„ Dry run: ${{ github.event.inputs.dry_run || 'false' }}"
            echo "- ðŸ—‘ï¸ Archive missing: ${{ github.event.inputs.archive_missing || 'true' }}"
            echo ""
            echo "### Results"
            echo "- ðŸ§¹ Product sync: Completed"
            if [[ "${{ github.event.inputs.create_collections }}" == "true" ]]; then
              echo "- ðŸ—‚ï¸ Collections: Created / Updated"
              echo "- ðŸš€ Auto publish: ${{ github.event.inputs.auto_publish }}"
            else
              echo "- ðŸ—‚ï¸ Collections: Skipped"
            fi
            echo ""
            echo "### Reports"
            echo "- ðŸ“„ needs_review.csv: Products that couldn't be auto-categorized"
            echo "- ðŸ“„ skipped_products.csv: Placeholder products that were skipped"
            echo ""
            echo "### Timestamp"
            echo "- â° UTC: $(date -u)"
          } >> $GITHUB_STEP_SUMMARY
